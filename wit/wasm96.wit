package wasm96:core@0.1.0;

/// The simplified wasm96 host ABI.
///
/// Design goals:
/// - Intuitive, safe API inspired by Processing, p5.js, and LÃ–VE.
/// - No direct buffer manipulation; Host handles clipping and rendering.
/// - Stateless immediate mode drawing.
world wasm96 {
  // =========================
  // Guest Exports
  // =========================

  /// Called once on startup. Initialize state and register screen size here.
  export setup: func();

  /// Called once per frame. Update game logic here.
  export update: func();

  /// Called once per frame after update. Draw to the screen here.
  export draw: func();

  // =========================
  // Host Imports
  // =========================

  import graphics: interface {
    /// Register screen dimensions.
    /// Should be called during `setup`.
    set-size: func(width: u32, height: u32);

    /// Set the current drawing color (RGBA).
    /// Affects subsequent drawing commands.
    set-color: func(r: u8, g: u8, b: u8, a: u8);

    /// Clear the screen with a specific color (RGB).
    /// Alpha is assumed 255.
    background: func(r: u8, g: u8, b: u8);

    /// Draw a single pixel at (x, y) with the current color.
    point: func(x: s32, y: s32);

    /// Draw a line from (x1, y1) to (x2, y2) with the current color.
    line: func(x1: s32, y1: s32, x2: s32, y2: s32);

    /// Draw a filled rectangle at (x, y) with size (w, h) using the current color.
    rect: func(x: s32, y: s32, w: u32, h: u32);

    /// Draw a rectangle outline at (x, y) with size (w, h) using the current color.
    rect-outline: func(x: s32, y: s32, w: u32, h: u32);

    /// Draw a filled circle at (x, y) with radius r using the current color.
    circle: func(x: s32, y: s32, r: u32);

    /// Draw a circle outline at (x, y) with radius r using the current color.
    circle-outline: func(x: s32, y: s32, r: u32);

    /// Draw an image/sprite at (x, y).
    /// `data` is a sequence of RGBA bytes (4 bytes per pixel).
    /// The host handles clipping and bounds checking.
    image: func(x: s32, y: s32, w: u32, h: u32, data: list<u8>);
  }

  import input: interface {
    enum button {
      b, y, select, start,
      up, down, left, right,
      a, x, l1, r1, l2, r2, l3, r3
    }

    /// Returns true if the specified button is currently held down.
    is-button-down: func(port: u32, btn: button) -> bool;

    /// Returns true if the specified key is currently held down.
    /// Key codes are implementation defined (e.g. USB HID or libretro key constants).
    is-key-down: func(key: u32) -> bool;

    /// Get current mouse X position.
    get-mouse-x: func() -> s32;

    /// Get current mouse Y position.
    get-mouse-y: func() -> s32;

    /// Returns true if the specified mouse button is held down.
    /// 0 = Left, 1 = Right, 2 = Middle.
    is-mouse-down: func(button: u32) -> bool;
  }

  import audio: interface {
    /// Initialize audio system.
    /// Returns the buffer size (in samples) that the host expects per frame.
    init: func(sample-rate: u32) -> u32;

    /// Push a chunk of audio samples.
    /// Samples are interleaved stereo (L, R, L, R...) signed 16-bit integers.
    /// This should be called once per frame in `update` or `draw`.
    push-samples: func(samples: list<s16>);
  }

  import storage: interface {
    /// Save data associated with a key.
    save: func(key: string, data: list<u8>);

    /// Load data associated with a key.
    load: func(key: string) -> list<u8>;
  }

  import system: interface {
    /// Log a message to the host console.
    log: func(message: string);

    /// Get the number of milliseconds since the app started.
    millis: func() -> u64;
  }
}
